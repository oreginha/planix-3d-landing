<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Chat Planix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">Panel de Administración - Chat</h1>
        
        <!-- Estadísticas -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold text-gray-700">Mensajes Hoy</h3>
                <p class="text-3xl font-bold text-blue-600" id="todayCount">-</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold text-gray-700">Total Mensajes</h3>
                <p class="text-3xl font-bold text-green-600" id="totalCount">-</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold text-gray-700">Pendientes</h3>
                <p class="text-3xl font-bold text-red-600" id="pendingCount">-</p>
            </div>
        </div>

        <!-- Filtros -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <div class="flex flex-wrap gap-4">
                <select id="dateFilter" class="px-4 py-2 border border-gray-300 rounded-lg">
                    <option value="today">Hoy</option>
                    <option value="week">Esta semana</option>
                    <option value="month">Este mes</option>
                    <option value="all">Todos</option>
                </select>
                <button id="refreshBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Actualizar
                </button>
                <button id="exportBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    Exportar CSV
                </button>
            </div>
        </div>

        <!-- Lista de Mensajes -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">Mensajes Recibidos</h2>
            </div>
            <div id="messagesList" class="divide-y divide-gray-200">
                <!-- Los mensajes se cargarán aquí -->
            </div>
        </div>

        <!-- Modal de Respuesta -->
        <div id="replyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4">
                <h3 class="text-lg font-semibold mb-4">Responder Mensaje</h3>
                
                <div id="originalMessage" class="bg-gray-100 p-4 rounded-lg mb-4">
                    <!-- Mensaje original -->
                </div>
                
                <form id="replyForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tu nombre</label>
                        <input type="text" id="adminName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Ej: Juan de Planix" required>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Respuesta</label>
                        <textarea id="replyMessage" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Escribe tu respuesta aquí..." required></textarea>
                    </div>
                    
                    <div class="flex gap-2">
                        <button type="button" id="cancelReply" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                            Cancelar
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Enviar Respuesta
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentMessages = [];
        let selectedMessage = null;

        // Cargar mensajes
        async function loadMessages() {
            try {
                const response = await fetch('./chat-admin.php');
                const data = await response.json();
                
                if (data.success) {
                    currentMessages = data.messages;
                    displayMessages(currentMessages);
                    updateStats(currentMessages);
                } else {
                    console.error('Error:', data.error);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Mostrar mensajes
        function displayMessages(messages) {
            const container = document.getElementById('messagesList');
            
            if (messages.length === 0) {
                container.innerHTML = '<div class="p-6 text-center text-gray-500">No hay mensajes</div>';
                return;
            }
            
            container.innerHTML = messages.map(msg => `
                <div class="p-6 hover:bg-gray-50 cursor-pointer" onclick="selectMessage('${msg.messageId}')">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-medium text-gray-900">${msg.userName || 'Usuario Anónimo'}</h4>
                            <p class="text-sm text-gray-600">${msg.userEmail || 'Sin email'}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-500">${new Date(msg.timestamp).toLocaleString('es-AR')}</p>
                            <span class="inline-block px-2 py-1 text-xs rounded-full ${msg.replied ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${msg.replied ? 'Respondido' : 'Pendiente'}
                            </span>
                        </div>
                    </div>
                    <p class="text-gray-800">${msg.message}</p>
                    <div class="mt-2 flex gap-2">
                        <button onclick="event.stopPropagation(); replyToMessage('${msg.messageId}')" 
                                class="text-sm px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Responder
                        </button>
                        <button onclick="event.stopPropagation(); markAsReplied('${msg.messageId}')" 
                                class="text-sm px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">
                            Marcar como respondido
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Actualizar estadísticas
        function updateStats(messages) {
            const today = new Date().toDateString();
            const todayMessages = messages.filter(msg => new Date(msg.timestamp).toDateString() === today);
            const pendingMessages = messages.filter(msg => !msg.replied);
            
            document.getElementById('todayCount').textContent = todayMessages.length;
            document.getElementById('totalCount').textContent = messages.length;
            document.getElementById('pendingCount').textContent = pendingMessages.length;
        }

        // Responder mensaje
        function replyToMessage(messageId) {
            const message = currentMessages.find(msg => msg.messageId === messageId);
            if (!message) return;
            
            selectedMessage = message;
            
            document.getElementById('originalMessage').innerHTML = `
                <div class="mb-2">
                    <strong>De:</strong> ${message.userName || 'Usuario Anónimo'} (${message.userEmail || 'Sin email'})
                </div>
                <div class="mb-2">
                    <strong>Fecha:</strong> ${new Date(message.timestamp).toLocaleString('es-AR')}
                </div>
                <div>
                    <strong>Mensaje:</strong> ${message.message}
                </div>
            `;
            
            document.getElementById('replyModal').classList.remove('hidden');
            document.getElementById('replyModal').classList.add('flex');
        }

        // Enviar respuesta
        document.getElementById('replyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!selectedMessage) return;
            
            const adminName = document.getElementById('adminName').value;
            const replyMessage = document.getElementById('replyMessage').value;
            
            try {
                const response = await fetch('./admin-reply.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: replyMessage,
                        userEmail: selectedMessage.userEmail,
                        adminName: adminName,
                        chatId: selectedMessage.messageId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Respuesta enviada correctamente');
                    closeReplyModal();
                    markAsReplied(selectedMessage.messageId);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error al enviar la respuesta');
                console.error(error);
            }
        });

        // Cerrar modal
        function closeReplyModal() {
            document.getElementById('replyModal').classList.add('hidden');
            document.getElementById('replyModal').classList.remove('flex');
            document.getElementById('replyForm').reset();
            selectedMessage = null;
        }

        // Marcar como respondido
        async function markAsReplied(messageId) {
            // Aquí podrías hacer una llamada al servidor para marcar como respondido
            const messageIndex = currentMessages.findIndex(msg => msg.messageId === messageId);
            if (messageIndex !== -1) {
                currentMessages[messageIndex].replied = true;
                displayMessages(currentMessages);
                updateStats(currentMessages);
            }
        }

        // Event listeners
        document.getElementById('cancelReply').addEventListener('click', closeReplyModal);
        document.getElementById('refreshBtn').addEventListener('click', loadMessages);

        // Exportar CSV
        document.getElementById('exportBtn').addEventListener('click', () => {
            const csv = [
                'Fecha,Nombre,Email,Mensaje,Respondido',
                ...currentMessages.map(msg => 
                    `"${new Date(msg.timestamp).toLocaleString('es-AR')}","${msg.userName || ''}","${msg.userEmail || ''}","${msg.message.replace(/"/g, '""')}","${msg.replied ? 'Sí' : 'No'}"`
                )
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat-messages-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        });

        // Cargar mensajes al inicio
        loadMessages();
        
        // Actualizar cada 30 segundos
        setInterval(loadMessages, 30000);
    </script>
</body>
</html>